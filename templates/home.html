{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="fw-bold">Plano del Restaurante</h2>
        <p class="text-muted">Estado en tiempo real de las mesas</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="card bg-white shadow-sm">
            <div class="card-body py-2">
                <span class="h4 fw-bold text-success">{{ libres }}</span> <small>Libres</small> / 
                <span class="h4 fw-bold">{{ total }}</span> <small>Totales</small>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div></div>
    <div>
        <a href="{% url 'crear_mesa' %}" class="btn btn-success me-2">Nueva Mesa</a>
        <a href="{% url 'listar_reservas' %}" class="btn btn-outline-primary">Reservas</a>
    </div>
</div>

<div class="d-flex gap-3 mb-4">
    <span class="badge bg-libre p-2">Libre</span>
    <span class="badge bg-ocupada p-2">Ocupada</span>
    <span class="badge bg-reservada p-2">Reservada</span>
    <span class="badge bg-limpieza p-2">Limpieza</span>
</div>

<div class="row g-4">
    {% for mesa in mesas %}
    <div class="col-6 col-md-4 col-lg-3">
        <div class="card mesa-card h-100 shadow-sm 
            {% if mesa.estado == 'LIBRE' %}bg-libre
            {% elif mesa.estado == 'OCUPADA' %}bg-ocupada
            {% elif mesa.estado == 'RESERVADA' %}bg-reservada
            {% elif mesa.estado == 'LIMPIEZA' %}bg-limpieza
            {% else %}bg-secondary{% endif %}" data-mesa-id="{{ mesa.id }}" data-mesa-num="{{ mesa.numero }}">
            
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h3 class="card-title mb-0">Mesa {{ mesa.numero }}</h3>
                <small class="mb-2">{{ mesa.ubicacion }} (Cap: {{ mesa.capacidad }})</small>
                <h5 class="text-uppercase fw-bold">{{ mesa.estado }}</h5>
                {% comment %} Mostrar reserva del día que corresponda a esta mesa (si existe) {% endcomment %}
                {% for r in reservas_activas %}
                    {% if r.mesa_asignada and r.mesa_asignada.id == mesa.id %}
                        <div class="mt-2 p-2 bg-white text-dark rounded shadow-sm">
                            <small class="fw-bold">Actualmente: {{ r.cliente.nombre }}</small><br>
                            <small class="text-muted">{{ r.fecha|date:'Y-m-d' }} • {{ r.hora_inicio|date:'H:i' }} → {{ r.hora_fin|date:'H:i' }}</small>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="mt-3">
                    {% if mesa.estado == 'LIBRE' %}
                        <button class="btn btn-light btn-sm w-100 fw-bold btn-abrir-modal-asignar" data-bs-toggle="modal" data-bs-target="#modalAsignar">
                            <i class="bi bi-person-check-fill"></i> Asignar
                        </button>
                    {% elif mesa.estado == 'OCUPADA' %}
                        <a href="{% url 'liberar_mesa' mesa.id %}" class="btn btn-light btn-sm w-100 fw-bold">
                            <i class="bi bi-box-arrow-right"></i> Liberar
                        </a>
                    {% elif mesa.estado == 'LIMPIEZA' %}
                        <form method="POST" action="{% url 'finalizar_limpieza' mesa.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-light btn-sm w-100 fw-bold">
                                <i class="bi bi-check2-all"></i> Marcar Limpieza
                            </button>
                        </form>
                    {% else %}
                        <button class="btn btn-outline-light btn-sm w-100" disabled>Gestión Bloqueada</button>
                    {% endif %}
                    <div class="mt-2 d-flex justify-content-center">
                        <div class="btn-group">
                            <a href="{% url 'editar_mesa' mesa.id %}" class="btn btn-sm btn-outline-secondary">Editar</a>
                            <a href="{% url 'eliminar_mesa' mesa.id %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-warning">No hay mesas configuradas. Ve al admin para crear mesas.</div>
    </div>
    {% endfor %}
</div>


<!-- Modal para asignar cliente a mesa -->
<div class="modal fade" id="modalAsignar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Mesa <span id="modalMesaNumero" class="fw-bold"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formAsignarModal" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="selectCliente" class="form-label">Selecciona Cliente</label>
                        <select id="selectCliente" name="cliente_id" class="form-select" required>
                            <option value="">-- Buscar / Seleccionar --</option>
                            {% for c in clientes %}
                                <option value="{{ c.id }}">{{ c.nombre }} — {{ c.telefono }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-text text-muted">Si el cliente no aparece, regístralo desde la sección Clientes.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar asignación</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function(){
        const modal = document.getElementById('modalAsignar');
        let mesaIdSeleccionada = null;

        // Al abrir modal desde cualquier botón, tomar la mesa asociada
        document.querySelectorAll('.btn-abrir-modal-asignar').forEach(btn => {
            btn.addEventListener('click', function(e){
                const card = e.target.closest('.card');
                const mesaId = card && card.getAttribute('data-mesa-id');
                const mesaNum = card && card.getAttribute('data-mesa-num');
                mesaIdSeleccionada = mesaId;
                document.getElementById('modalMesaNumero').textContent = mesaNum ? ('#' + mesaNum) : '';
                // establecer action del formulario dinámicamente usando la URL patrón
                // `/Cliente/<cliente_id>/asignar/<mesa_id>/` será completado al enviar
            });
        });

        // Interceptar envío y redirigir via POST al endpoint con cliente y mesa
        document.getElementById('formAsignarModal').addEventListener('submit', function(e){
            e.preventDefault();
            const clienteId = document.getElementById('selectCliente').value;
            if(!clienteId || !mesaIdSeleccionada){
                alert('Selecciona un cliente y vuelve a intentar.');
                return;
            }

            // Crear formulario POST dinámico para enviar CSRF token y ejecutar la acción
            const action = `/Cliente/${clienteId}/asignar/${mesaIdSeleccionada}/`;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = action;
            // agregar CSRF
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        });
    })();
</script>
{% endblock %}